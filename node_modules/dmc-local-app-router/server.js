const express = require("express");
const fs = require('fs')
const bodyParser = require("body-parser");
const packageJson = require('./package.json');
const open = require('opn');
const app = express();
const yaml = require('yaml');
const cors = require('cors');

//reading the configurations
const configs = JSON.parse(fs.readFileSync('local-configs.json'));
const mtaConfigs = yaml.parse(fs.readFileSync('mta.yaml','utf-8'));

//getting the routes
const addIntRoutes = require('./routes/internalRoutes')
const addExtRoutes = require('./routes/extRoutes');

app.use(bodyParser.json());
app.use(express.static(configs.localDir || mtaConfigs.modules[0].path+'/webapp'));
app.use(cors());

addIntRoutes().then(internalRoutes=>{
  internalRoutes && app.use(internalRoutes)
  return addExtRoutes()
}).then(extRoutes=>{
  extRoutes && app.use(extRoutes);

  app.listen(configs.port, () => {
    console.log(`Server is listening on port ${configs.port}`);
    let url = `http://localhost:${configs.port}`
    open(url).then(() => {
      console.log("Opened UI5 App in browser", url)
    }).catch(err => console.log(err))
  });
})

console.log('dmc-local-app-router version: '+packageJson.version)
console.log('Starting the application....')
